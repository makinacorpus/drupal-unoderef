{"version":3,"file":"unoderef.js","sourceRoot":"/var/www/chlovet/web/sites/all/modules/composer/drupal-unoderef/dist/","sources":["behavior.ts","unoderef.ts"],"names":[],"mappings":"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","sourcesContent":["\n// @todo not sure it meant to be used that way\ndeclare const Drupal: any;\n\nDrupal.behaviors.unoderefDragula = {\n    attach: function(context: Document | Element | any) {\n\n        // This should not happen, but some Drupal module will attempt\n        // attaching items on jQuery selectors instead of DOM elements.\n        if (!context.querySelectorAll) {\n            if (context.get) {\n                context = <Element>context.get(0);\n            } else {\n                return;\n            }\n        }\n\n        for (let node of <any>context.querySelectorAll(UNodeRef.SELECTOR_WIDGET)) {\n            UNodeRef.initializeWidget(node);\n        }\n    }\n};\n","/**\n * ÂµNodeReference Dragula based code.\n */\nnamespace UNodeRef {\n\n    export readonly const DATA_BUNDLES = \"data-allowed-bundles\";\n    export const DATA_ITEM_BUNDLE = \"data-bundle\";\n    export const DATA_ITEM_ID = \"data-id\";\n    export const DATA_ITEM_TYPE = \"data-type\";\n    export const SELECTOR_SOURCES = \"[data-layout-source=\\\"1\\\"]\";\n    export const SELECTOR_WIDGET = \".unoderef-items\";\n\n    /**\n     * Reprensents a base widget\n     */\n    class Widget {\n\n        allowedBundles: string[] | null;\n        container: Element;\n        drake: dragula.Drake;\n        valueInput: HTMLInputElement;\n\n        /**\n         * Default constructor\n         */\n        constructor(container: Element) {\n            this.container = container;\n\n            // Value element is always a sibling, find it\n            if (!this.container.parentElement) {\n                throw \"Cannot find parent container\";\n            }\n            const node = this.container.parentElement.querySelector(\"input[type=hidden]\");\n            if (node instanceof HTMLInputElement) {\n                this.valueInput = node;\n            } else {\n                throw \"Cannot find hidden input\";\n            }\n\n            // Parse allowed bundles\n            if (this.container.hasAttribute(DATA_BUNDLES)) {\n                const data = this.container.getAttribute(DATA_BUNDLES);\n                if (data) {\n                    this.allowedBundles = data.split(\",\");\n                }\n            }\n\n            // Refresh items, upon initial page build they do not have the\n            // correct wrapper and remove button\n            for (let child of <any>this.container.childNodes) {\n                this.addItem(child);\n            }\n        }\n\n        /**\n         * Refresh value\n         */\n        refreshValue(): void {\n            const order: string[] = [];\n            for (let child of <any>this.container.childNodes) {\n                const id = child.getAttribute(DATA_ITEM_ID);\n                if (id) {\n                    order.push(id);\n                } else {\n                    this.container.removeChild(child);\n                }\n            }\n            this.valueInput.setAttribute('value', order.join(','));\n        }\n\n        /**\n         * Can this widget accept the given element\n         */\n        accepts(element: Element): boolean {\n            if (!element.hasAttribute(DATA_ITEM_ID) || !element.hasAttribute(DATA_ITEM_TYPE) || 'node' !== element.getAttribute(DATA_ITEM_TYPE)) {\n                return false;\n            }\n            if (this.allowedBundles) {\n                const bundle = element.getAttribute(DATA_ITEM_BUNDLE);\n                if (bundle) {\n                    return -1 !== this.allowedBundles.indexOf(bundle);\n                }\n            }\n            return true;\n        }\n\n        /**\n         * Remove all items\n         */\n        removeAllItems() {\n            for (let child of <any>this.container.childNodes) {\n                this.container.removeChild(child);\n            }\n        }\n\n        /**\n         * Replaces the list element with the correct representation\n         */\n        addItem(element: Element): void {\n            const newElement = this.cloneItem(element);\n            try {\n                this.container.replaceChild(newElement, element);\n            } catch (e) {\n                // Element does not exists in container, append child instead\n                this.container.appendChild(newElement);\n            }\n            this.refreshValue();\n        }\n\n        /**\n         * Clone item on drop\n         */\n        cloneItem(element: Element): Element {\n            const newElement = document.createElement('div');\n            newElement.className = 'unoderef-item';\n            newElement.setAttribute(DATA_ITEM_TYPE, <string>element.getAttribute(DATA_ITEM_TYPE));\n            newElement.setAttribute(DATA_ITEM_BUNDLE, <string>element.getAttribute(DATA_ITEM_BUNDLE));\n\n            const innerClone = <Element>element.cloneNode(true);\n            innerClone.removeAttribute('class');\n            newElement.appendChild(innerClone);\n\n            // Create close button\n            const closeButton = document.createElement('span');\n            closeButton.setAttribute(\"class\", \"glyphicon glyphicon-remove\");\n            newElement.appendChild(closeButton);\n\n            // Attach remove button behavior\n            closeButton.onclick = () => {\n                if (newElement.parentElement) {\n                    newElement.parentElement.removeChild(newElement);\n                    this.refreshValue();\n                }\n            };\n\n            return newElement;\n        }\n    }\n\n    export function initializeWidget(node: Element) {\n\n        // Find all potential sources in document, in order to make it\n        // easier for everybody, we re-use the phplayout and ucms sources\n        // so it'll work globally transparently.\n        const sources: Element[] = [];\n        for (let source of <any>document.querySelectorAll(SELECTOR_SOURCES)) {\n            sources.push(source);\n        };\n\n        // No sources mean that the widgets cannot work.\n        if (!sources.length) {\n            return;\n        }\n\n\n        // FIXME re-implement this properly\n        // Handle browser refresh, if no items are displayed and hidden field is\n        // not empty, search for items in page or empty hidden field.\n        //          if (!$list.find('.unoderef-item').length && hidden.getAttribute('value')) {\n        //            const found = true;\n        //            $.each(hidden.getAttribute('value').split(','), function (nid) {\n        //              $('[data-item-id=' + nid + ']').clone().attr('class', '').addClass('unoderef-item').appendTo($list);\n        //            });\n        //            if (!found) {hidden.setAttribute('value', \"\");}\n        //          }\n\n        const widget = new Widget(node);\n        const allContainers: Element[] = sources.concat([widget.container]);\n        widget.drake = dragula(allContainers, {\n            copy: true,\n            accepts: (element: Element, target: Element) => target === widget.container && widget.accepts(element),\n            // invalid: (element: Element) => !$(element).closest('[data-item-type]').length,\n            revertOnSpill: true,\n            removeOnSpill: false,\n            direction: 'horizontal'\n        });\n\n        if (!widget.container.getAttribute('data-multiple')) {\n            widget.drake.on('drop', function(element: Element) {\n                widget.removeAllItems();\n                widget.addItem(element);\n            });\n        } else {\n            widget.drake.on('drop', function(element: Element) {\n                widget.addItem(element);\n            });\n        }\n    }\n}\n"]}